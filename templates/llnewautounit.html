{% extends "layout.html" %}

{% set category="队伍编成和强度" %}
{% set category_link="/#unit-formation" %}
{% set title="自动组队" %}

{% block additional_header %}
   <script type="text/javascript" src="{{ url_for('static', filename='twintailosu.js') }}?v=1.01"></script>
   <script type="text/javascript" src="{{ url_for('static', filename='lldata.js') }}"></script>
   <script type="text/javascript" src="/static/js/highcharts/highcharts.js"></script>
   <link rel="shortcut icon" href="/static/shortcuticon.png" />
{% endblock %}

{% block script %}
   <script>
   var mezame = 0;
   var kizuna = new Array();
   kizuna["N"] = [25, 50]
   kizuna["R"] = [100, 200]
   kizuna["SR"] = [250, 500]
   kizuna["SSR"] = [375, 750]
   kizuna["UR"] = [500, 1000]

   LLCardData.briefKeys.push('minslot');
   var defer_onload = $.Deferred();
   var data_mapnote = 0;
   var comp_skill = 0;
   var comp_cardselector = 0;
   var comp_songselector = 0;
   var comp_gemselector = 0;
   var comp_cardavatar = 0;
   var comp_gemstock = 0;
   var comp_submember = 0;
   var comp_swapper = 0;
   var comp_distribution_chart = 0;
   var comp_distribution_param = 0;
   var comp_team = 0;
   var comp_cskill_team = 0;
   var comp_cskill_friend = 0;
   var comp_result = 0;
   var comp_language = 0;

   $.when(LLCardData.getAllBriefData(), LLSongData.getAllBriefData(), LLMetaData.get(), defer_onload).then(function (cardData, songData, metaData) {
      // init components
      LLConst.initMetadata(metaData);
      comp_songselector = new LLSongSelectorComponent('song_filter', songData);
      data_mapnote = new LLMapNoteData();
      comp_skill = new LLSkillContainer();
      comp_cardselector = new LLCardSelector(cardData, 'card_filter_container');
      comp_cardselector.onCardChange = LLUnit.applycarddata;
      comp_cardavatar = new LLImageComponent('imageselect');
      comp_distribution_param = new LLScoreDistributionParameter('distribution_param');
      comp_distribution_param.loadJson(LLHelperLocalStorage.getData(LLHelperLocalStorage.localStorageDistParamKey));
      comp_cskill_team = new LLCSkillComponent('cskill_team');
      comp_cskill_friend = new LLCSkillComponent('cskill_friend', {'editable': true, 'title': '好友主唱技能'});
      comp_result = new LLUnitResultComponent('unit_result');
      comp_gemselector = new LLGemSelectorComponent('gem_filter', {'includeNormalGemCategory': true});

      comp_songselector.onSongSettingChange = (songSettingId, songSetting) => songSetting && comp_team.setWeights(songSetting.positionweight);
      comp_songselector.onSongColorChange = (songAttribute) => comp_team.setMapAttribute(songAttribute);
      comp_songselector.setFriendCSkillComponent(comp_cskill_friend);

      comp_language = new LLLanguageComponent('language');
      comp_language.onValueChange = function (language) {
         comp_songselector.setLanguage(language);
         comp_cardselector.setLanguage(language);
      };

      var comp_dataversion = new LLDataVersionSelectorComponent('card_data_version', LLCardData, function (v) {
         LoadingUtil.startSingle(LLCardData.getAllBriefData().then(function (cards) {
            comp_cardselector.setCardData(cards, true);
         }));
      });
      var comp_savestorage = new LLSaveStorageComponent('unit-storage', {
         'saveData': makeSaveData,
         'loadTeamMember': handleLoadTeamMember,
         'loadGemStock': function(data) { if (comp_gemstock) comp_gemstock.loadData(data); },
         'loadSubMember': handleLoadSubMember
      });
      comp_team = new LLTeamComponent('unit-team', {
         'onPutCardClicked': function(i) {
            var curMain = document.getElementById("main").value;
            var memberData = {
               'cardid': comp_cardselector.getCardId(),
               'mezame': (document.getElementById("mezame").checked ? 1 : 0),
               'hp': parseInt(document.getElementById("hp").value),
               'smile': parseInt(document.getElementById("smile").value),
               'pure': parseInt(document.getElementById("pure").value),
               'cool': parseInt(document.getElementById("cool").value),
               'skilllevel': parseInt(document.getElementById("skilllevel").innerHTML)
            };
            memberData[curMain] += parseInt(document.getElementById("kizuna").value);
            comp_team.putMember(i, memberData);
         },
         'onPutGemClicked': function (i) {
            return comp_gemselector.getGemId();
         },
         'onCenterChanged': function() {
            LoadingUtil.startSingle(LLCardData.getDetailedData(this.getCardId(4) || 0)).then(function(card) {
               comp_cskill_team.setCSkill(card);
            }, defaultHandleFailedRequest);
         }
      });
      comp_team.loadJson(LLHelperLocalStorage.getData(LLHelperLocalStorage.localStorageLLNewAutoUnitTeamKey));

      init();

      comp_gemstock = new LLGemStockComponent('sisreserves');

      var subMembersOperation = new LLComponentBase('submembersoperation');
      comp_submember = new LLSubMemberComponent('submembers');
      comp_swapper = new LLSwapper();
      comp_submember.setSwapper(comp_swapper);
      comp_submember.setOnCountChange(function (count) {
         if (count > 0) subMembersOperation.show();
         else subMembersOperation.hide();
      });
      comp_team.setSwapper(comp_swapper);

      // load
      comp_language.deserialize(parseInt(LLHelperLocalStorage.getData(LLHelperLocalStorage.localStorageLanguageKey, 0)));
      comp_cardselector.loadLocalStorage(LLHelperLocalStorage.localStorageCardSelectKey);
      comp_songselector.loadJson(LLHelperLocalStorage.getData(LLHelperLocalStorage.localStorageSongSelectKey));
      comp_gemstock.loadJson(localStorage.getItem('llnewautounit_gemstock'));
      comp_submember.loadJson(localStorage.getItem('llnewautounit_submember'));
      comp_team.setMapAttribute(comp_songselector.getSongAttribute());

      // done
      document.getElementById('loadingbox').style.display = 'none';
   }, defaultHandleFailedRequest);
   
   function toMezame(){
   	mezame = 1-mezame
      LLUnit.applycarddata();
   }


   function clearall(){
   	setCookie("mezame"+"unit", mezame, -1)
      localStorage.removeItem('llnewautounit_gemstock');
      localStorage.removeItem('llnewautounit_submember');
      LLHelperLocalStorage.clearData(LLHelperLocalStorage.localStorageLanguageKey);
      LLHelperLocalStorage.clearData(LLHelperLocalStorage.localStorageCardSelectKey);
      LLHelperLocalStorage.clearData(LLHelperLocalStorage.localStorageSongSelectKey);
      LLHelperLocalStorage.clearData(LLHelperLocalStorage.localStorageLLNewAutoUnitTeamKey);
      window.location.href="/llnewautounit"
   }

   function makeSaveData() {
      return new LLSaveData({'version': 104, 'team': comp_team.getMembers(), 'gemstock': comp_gemstock.saveData(), 'submember': comp_submember.saveData()});
   }

   function handleLoadTeamMember(teamMember) {
      comp_team.setMembers(teamMember);
      precalcu();
   }

   function handleLoadSubMember(subMember) {
      var requests = [];
      for (var i = 0; i < subMember.length; i++) {
         (function(index){
            // data has: 'cardid','mezame','skilllevel','maxcost'
            var cur = subMember[index];
            if ((!cur.maxcost) || (!cur.main)) {
               requests.push(LLCardData.getDetailedData(cur.cardid).then(function (card) {
                  if (!cur.maxcost) cur.maxcost = card.minslot;
                  if (!cur.main) {
                     var intMezame = parseInt(cur.mezame);
                     cur.main = card.attribute;
                     cur.smile = (intMezame ? card.smile2 : card.smile);
                     cur.pure = (intMezame ? card.pure2 : card.pure);
                     cur.cool = (intMezame ? card.cool2 : card.cool);
                     cur[cur.main] += kizuna[card.rarity][intMezame];
                     cur.hp = (intMezame ? card.hp+1 : card.hp);
                  }
               }));
            }
         })(i);
      }
      LoadingUtil.start(requests).then(function () {
         comp_submember.loadData(subMember);
      }, defaultHandleFailedRequest);
   }

   function loadSaveData(data, loadTeam, loadGemStock, loadSubMember) {
      var saveData = new LLSaveData(data);
      if (loadTeam) {
         handleLoadTeamMember(saveData.teamMember);
      }
      if (loadGemStock) {
         if (saveData.hasGemStock) {
            comp_gemstock.loadData(saveData.gemStock);
         }
      }
      if (loadSubMember) {
         handleLoadSubMember(saveData.subMember);
      }
   }

   function savesis(){
      var saveData = makeSaveData();
      var unitjson = saveData.serializeV104(true, false, true);
      window.location.href="/llsavesis/"+unitjson;
   }
   function saveunit(){
      var saveData = makeSaveData();
      var unitjson = saveData.serializeV104();
      window.location.href="/llsaveunit/"+unitjson;
   }
   function savesubmembers(){
      var saveData = makeSaveData();
      var submembersjson = saveData.serializeV104(true, true, false);
      window.location.href="/llsavesubmembers/"+submembersjson;
   }
   function saveallmembers(){
      var saveData = makeSaveData();
      saveData.subMember = saveData.subMember.concat(saveData.teamMember);
      var submembersjson = saveData.serializeV104(true, true, false);
      window.location.href="/llsaveallmembers/"+submembersjson;
   }
   function handleLoadSis(sis) {
      loadSaveData(sis, 0, 1, 0);
   }
   function handleLoadUnit(unit) {
      loadSaveData(unit, 1, 1, 0);
   }
   function handleLoadSubmembersData(data) {
      loadSaveData(data, 0, 0, 1);
   }

   function loadunit(){
      document.getElementById("unitform").action = '/llload/parent.handleLoadUnit'
   	document.getElementById("unitform").target = 'if'
   }
   function precalcu(){
   	document.getElementById("unitform").action = ''
   	document.getElementById("unitform").target = ''
   }
   function loadsis(){
	document.getElementById("unitform").action = '/llloadex/filesis/parent.handleLoadSis'
   	document.getElementById("unitform").target = 'if'
   }
   function loadsubmembers(){
      document.getElementById("unitform").action = '/llloadex/filesub/parent.handleLoadSubmembersData'
      document.getElementById("unitform").target = 'if'
   }

   function init(){
   	mezame = getCookie("mezameunit")
      if (mezame == "") mezame = 0; else mezame = parseInt(mezame);

      document.getElementById("mezame").checked = mezame
   }

   function saveToCookie(){
   	setCookie("mezame"+"unit", mezame, 1)
   }
   //////////
   function addselectsub(){
      var cardid=document.getElementById("cardchoice").value;
      var subunit={}
      if ((cardid != 0) && (cardid != "") && (cardid != "0")){
         subunit["main"]=document.getElementById("main").value
         subunit["smile"]=parseInt(document.getElementById("smile").value)
         subunit["pure"]=parseInt(document.getElementById("pure").value)
         subunit["cool"]=parseInt(document.getElementById("cool").value)
         subunit[subunit["main"]]+=parseInt(document.getElementById("kizuna").value)
         subunit["skilllevel"]=comp_skill.skillLevel+1;
         subunit["mezame"]=parseInt(mezame)
         subunit["cardid"]=cardid;
         subunit["maxcost"]=comp_cardselector.cards[cardid].minslot;
         subunit.hp = parseInt(document.getElementById("hp").value);
         comp_submember.add(subunit);
      }
   }
   function autoarm(){
      if(document.getElementById('autoarm0').checked){
         document.getElementById("sisreserves").style.display = '';
      }
      else{
         document.getElementById("sisreserves").style.display = 'none';
      }
   }

   function fillunit(){
      if (comp_submember.empty()) return;
      var i;
      var emptypos = [];
      for (i = 0; i < 9; i++) {
         if (i == 4) continue;
         var cardid = comp_team.getCardId(i);
         if ((!cardid) || cardid == '0') emptypos.push(i);
      }
      if (emptypos.length == 0) return;
      var submembers = comp_submember.saveData();
      for (i = 0; i < emptypos.length && i < submembers.length; i++) {
         comp_team.setMember(emptypos[i], submembers[i]);
      }
      comp_submember.remove(0, i);
   }

   function check(){
      if (!comp_songselector.getSelectedSongSetting()) {
         comp_result.showError('请选择谱面');
         return;
      }
      if (!comp_team.isAllMembersPresent()) {
         comp_result.showError('队伍中仍有空位');
         return;
      }
      comp_result.hideError();
      saveToCookie();
      localStorage.setItem('llnewautounit_gemstock', comp_gemstock.saveJson());
      localStorage.setItem('llnewautounit_submember', comp_submember.saveJson());
      LLHelperLocalStorage.setData(LLHelperLocalStorage.localStorageLanguageKey, comp_language.serialize())
      comp_cardselector.saveLocalStorage(LLHelperLocalStorage.localStorageCardSelectKey);
      LLHelperLocalStorage.setData(LLHelperLocalStorage.localStorageSongSelectKey, comp_songselector.saveJson());
      LLHelperLocalStorage.setData(LLHelperLocalStorage.localStorageDistParamKey, comp_distribution_param.saveJson());
      LLHelperLocalStorage.setData(LLHelperLocalStorage.localStorageLLNewAutoUnitTeamKey, comp_team.saveJson());
	/////////////
      var cardids = comp_team.getCardIds();
      var subMembers = comp_submember.saveData();
      for (var i = 0; i < subMembers.length; i++) {
         cardids.push(subMembers[i].cardid);
      }
      var distParam = comp_distribution_param.saveData();
      if (distParam.type == 'sim') {
         LLUnit.calculate(docalculate, cardids, [data_mapnote.getMapNoteData(comp_songselector.getSelectedSong(), comp_songselector.getSelectedSongSetting())]);
      } else {
         LLUnit.calculate(docalculate, cardids);
      }
      return true;
   }

   function docalculate(cards, extraData) {
      var member = comp_team.getMembers();
      var llmembers = [];

      var mainatt = comp_songselector.getSongAttribute();

      for (var i = 0; i < 9; i++) {
         member[i].card = cards[member[i].cardid];
         llmembers.push(new LLMember(member[i], mainatt));
      }

      var distParam = comp_distribution_param.saveData();
      var llmap = comp_songselector.getMap(comp_team.getWeights());

      var llteam = new LLTeam(llmembers);
      if (document.getElementById('autoarm0').checked){
         // autounit
         var saveData = makeSaveData();
         var subMembers = [];
         for (var i = 0; i < saveData.subMember.length; i++) {
            var member = saveData.subMember[i];
            member.card = cards[member.cardid];
            member.gems = [];
            subMembers.push(new LLMember(member));
         }
         var resultSubMembers = llteam.autoUnit(llmap, saveData.gemStock, subMembers);
         for (var i = 0; i < 9; i++) {
            comp_team.setMember(i, llteam.members[i].raw);
            comp_team.setMemberGem(i, llteam.members[i].gems);
         }
         comp_submember.loadData(resultSubMembers.map(x => x.raw));
      }
      llteam.calculateAttributeStrength(llmap);
      llteam.calculateSkillStrength(llmap);

      comp_team.setStrengthAttributes(llteam.attrStrength);
      comp_team.setStrengthDebuffs(llteam.attrDebuff);

      if (distParam.type != 'no'){
         var t0 = window.performance.now();

         var percentiles = [1, 2, 5, 10, 20, 30, 40, 50, 60, 70, 80, 90, 95, 98, 99];
         var err;
         if (distParam.type == 'v1') {
            err = llteam.calculateScoreDistribution();
         } else if (distParam.type == 'sim') {
            llmap.setDistParam(distParam);
            err = llteam.simulateScoreDistribution(llmap, extraData[0], parseInt(distParam.count));
         } else {
            err = '未知的得分分布';
         }
         if (err) {
            comp_result.showError(err);
         } else {
            llteam.calculatePercentileNaive();
            comp_result.hideError();
         }
         var t1 = window.performance.now();
         console.debug(llteam);

         console.debug('Elapesd time (ms): ' + (t1 - t0).toFixed(3));
         for (var i in percentiles){
            document.getElementById('simresult'+(100-percentiles[i]).toString()).innerHTML = llteam.naivePercentile[percentiles[i]];
         }
         document.getElementById('maxscoreprobability').innerHTML = '(' + (llteam.probabilityForMaxScore * 100) + ')%';
         document.getElementById('minscoreprobability').innerHTML = '(' + (llteam.probabilityForMinScore * 100) + ')%';
         document.getElementById('simresult0').innerHTML = llteam.maxScore;
         document.getElementById('simresult100').innerHTML = llteam.minScore;
         document.getElementById('distributionresult').style.display = '';
         if (!comp_distribution_chart) {
            comp_distribution_chart = new LLScoreDistributionChart('score_chart', {'series': [llteam.naivePercentile], 'width': '100%', 'height': '400px'});
         } else {
            comp_distribution_chart.addSeries(llteam.naivePercentile);
         }
      } else {
         document.getElementById('distributionresult').style.display = 'none';
         comp_result.hideError();
      }

      comp_team.setResult(llteam);
      comp_result.showResult(llteam);
   }

   </script>
{% endblock %}

{% block body_onload %}
   <body onload="defer_onload.resolve()" lang="zh-Hans">
{% endblock %}

{% block front_notice %}
<h4 class="alert-heading">使用方法</h4>
<ol>
      <li>选择歌曲 或 填写歌曲详细信息 <font style='color:red'><b>务必记得修改perfect数量</b></font></li>
      <li>从卡牌库中选择一张卡，点击转移来放置到对应位置，没有录入的卡片数据可以手动输入 <font style='color:red'><b>一张卡默认为满级、一级技能的数据，若不是则需要修改</b></font></li>
      <li>使用以上方法选择所有的9张卡</li>
      <li>可以点击「保存队伍」将队伍配置文件保存到本地</li>
      <li>第2、3步可以从保存的文件中读取队伍信息来代替：点击「选择文件」选择本地配置文件，再点击「读取队伍」</li>
	<li>选择主唱技能和好友主唱技能 <font style='color:red'><b>计算SM得分时将好友主唱加成设为0%</b></font></li>
	<li>勾选或取消「自动配饰」选择是否在点击Calculate计算时自动计算最优策略 勾选后请填写每种偶像技能的拥有数量，「保存仓库」与「读取仓库」可以存取宝石文件信息</li>
	<li>选择卡片后点击「添加后备」可设为增加候补成员，其下方的选择文件与读取队伍可以将后备队伍文件或队伍文件作为后备成员添加到后备中</li>
	<li>选择后备成员界面中的「保存全卡」可以保存所有成员，包括队伍与后备，点击「队伍填充」可将后备成员前8名填充至除主唱外的位置中</li>
      <li>点击Calculate</li>
	<li>更多详情，请访问<a href="https://tieba.baidu.com/p/5242588398"><font color="#FF0000"><b>说明与反馈</b></font></a></li>
</ol>

<p>当前版本：4.1及以上。</p>
{% endblock %}

{% block main %}
<input class='btn btn-default' type="submit" name="clear" value="清空输入" onclick="clearall()" /><br/>
<input id='language' type='hidden' /><br/>
<form action="" id="unitform" name="unitform" method="POST" enctype=multipart/form-data>
<h3>歌曲信息</h3>
<div id="song_filter" class="filter-form label-size-9">载入中...</div>

{% include 'components/card-selector.html' %}

<div style="float:left">
<input type="button" id="addSubselect" value="添加后备" onclick="addselectsub()" ></input>
<input type="file" name="filesub">
<input type="submit" value="读取队伍" onclick="loadsubmembers()">
</div>
<br><br>
<div style="clear:both"></div>

<div id="submembersoperation" style="display: none">
<h4> 备选成员<input type="button" value="保存后备" onclick="savesubmembers()"><input type="button" value="保存全卡" onclick="saveallmembers()"><input type="button" value="队伍填充" onclick="fillunit()"></h4>
</div>
<div id="submembers">
</div>

<div style="clear:both"></div>

<h3>宝石选择</h3>
<div id="gem_filter" class="filter-form">载入中...</div>

<h3>队伍属性</h3>
<div class="col-xs-12 col-lg-9" style="overflow-x:auto" id="unit-team"></div>
<div class="col-xs-12 col-md-3">
   <input type="button" value="保存队伍" onclick="saveunit()">
   <input type="file" name="file"/>
   <input type="submit" value="读取队伍" onclick="loadunit()">

   <div id="unit-storage" style="margin-top:30px">
</div>

</div>

<div class="col-xs-12 col-md-3 gem-stock-list-group" id="sisreserves" style='display:none'>
   <input type="button" onclick="savesis()" value="保存仓库" />
   <input type="file" name="filesis">
   <input type="submit" value="读取仓库" onclick="loadsis()">
</div>

<div class="col-xs-12 col-md-9">
<div id='cskill_team'></div>
<div id='cskill_friend'></div>

<br/>
<div id="distribution_param"></div>
<input type="button" value="calculate" onclick="check()" />
<input type="checkbox" id="autoarm0" name="autoarm0" onclick="autoarm()">自动组队及配饰</input>
</div>
</form>

<iframe style="display:none" id='if' name='if' src='about:blank' frameborder='0' allowtransparency="yes"></iframe>

{% include 'components/loadingbox.html' %}

<div style="clear:both"></div>

<div id="unit_result"></div>
<div id='distributionresult' style='display:none'>
<h3>得分分布</h3>
最高分：<span id='simresult0'></span>&nbsp;概率：<span id='maxscoreprobability'></span><br/>
最低分：<span id='simresult100'></span>&nbsp;概率：<span id='minscoreprobability'></span><br/>
<table border="1">
<tr>
	<td>1%</td>
	<td>2%</td>
	<td>5%</td>
	<td>10%</td>
	<td>20%</td>
	<td>30%</td>
	<td>40%</td>
	<td>50%</td>
	<td>60%</td>
	<td>70%</td>
	<td>80%</td>
	<td>90%</td>
	<td>95%</td>
	<td>98%</td>
	<td>99%</td>
</tr>
<tr>
	<td id='simresult1'></td>
   <td id='simresult2'></td>
   <td id='simresult5'></td>
   <td id='simresult10'></td>
   <td id='simresult20'></td>
   <td id='simresult30'></td>
   <td id='simresult40'></td>
   <td id='simresult50'></td>
   <td id='simresult60'></td>
   <td id='simresult70'></td>
   <td id='simresult80'></td>
   <td id='simresult90'></td>
   <td id='simresult95'></td>
   <td id='simresult98'></td>
   <td id='simresult99'></td>
</tr>
</table>
</div>
<div id='score_chart' style='width:100%;display:none'></div>
{% endblock %}

{% block back_notice %}
<h4 class="alert-heading">注意</h4>
<ul>
   <li>勾选「计算分布」来计算得分分布。得分分布使用真实分布计算，计算速度比较慢。</li>
   <li>计算「自动配饰」的时候建议先不勾选「计算分布」以免时间过长，得到最优宝石配置后取消「自动配饰」再计算得分分布。</li>
   <li>由于使用歌曲信息计算，最终结果可能会有千分之一的误差</li>
   <li>判定覆盖率仅供参考</li>
   <li>判定期间属性1.25倍的宝石计算有误，暂时按无效计算。</li>
   <li>在队伍中有爆分SR时，由于技能强度会随着队伍强度变化而变化，可能出现多次计算「自动配饰」得到的结果不唯一的情况，此时只需重复计算多次取强度最高者即可。</li>
   <li>为保险起见，请在有后备队员时自动组队计算后再点一次calculate，若有变化请点击「问题反馈」留言</li>
   <li>日服新宝石的计算正在测试中，可能有计算错误，欢迎反馈</li>
</ul>
{% endblock %}
{% block back_notice_2 %}
<h4 class="alert-heading">说明</h4>
<ul>
   <li>在卡片数据行中的判定指的该卡片的边际判定覆盖率影响，即撤掉这张卡后边际覆盖率的损失。在括号中的覆盖率为单卡判定覆盖率</li>
   <li>卡强度指的是不考虑异色和异团带来的负面影响时的强度，该数值方便异团卡、异色横向比较。实际强度则是考虑异色和异团加成的强度</li>
</ul>
{% endblock %}
